# Linux（Cent OS 7.x）

## Linux 基础

Linux 默认有六个终端，使用 Ctrl + Alt + F1~F6 来切换，被命名为 tty1~tty6 。首次登录的界面默认为 tty1 。如果是图形界面，则 tty1 被图形界面占领；若为命令行界面，则被命令行界面占领。

teletype：简称 TTY。

## 特殊符号

`|`：管道符号，表示前面命令的输出结果通过管道交由后续的命令继续使用。

`;`：分号，可以在同一行中依次执行多条命令。

nano 中，X 表示 Alt 键。

### 命令注释：

`#`：在命令头加上它，表示注释掉该行。★

## 常用命令

命令后接 `-`，后紧跟选项的缩写；接`--`则紧跟全称。

### 1. 基础命令

`date`：显示日期与时间。

`locale`（`echo $LANG`）：显示目前支持的语系。

`cal`：显示日历。

`bc`：计算器。(quit 退出，scale 设置显示的小数位数)

`echo`：在屏幕上显示输入的信息。

`uname`：打印系统信息。

### 2. 文件操作

`cp`：拷贝文件。

#### 1. 修改文件权限：

`chgrp`：修改用户组。

`chown`：修改用户（也可以修改用户组：`chown User:Group filename/dirname`（使用逗号也行）或者 `chown :Group filename/dirname`）。

`chmod`：修改权限。有两种方法：数字修改（r：4，w：2，x：1）、符号修改。

若设置特殊权限（SUID：4、SGID：2、SBIT：1），则需在原来的三位数字前面再多加一位数：

```bash
chmod 4755 filename

// 也可以使用符号修改
chmod u=rwxs,go=x test
chmod g+s,o+t test
```

SUID：对目录无效；SGID：对文件和目录有效；SBIT：仅对目录有效。

这三个权限都需要 x 权限，它们是取代 x 权限的，如果没有 x 权限就设置它们，会显示大写的 S 与 T 。★

---

`basename`：获取路径的文件名。

`dirname`：获取路径的目录名。

#### 2. 查看文件内容：

`cat`：查看文件内容。

`tac`：反向查看。

`nl`：默认显示行号。

`more`：一页一页的显示文件内容。（使用`less`替代）

`less`：增强的`more`。

`head`：只看前面几行。

`tail`：只看后面几行。

`od`：以二进制方式读取文件内容。

---

`umask`：文件及目录的默认权限管理。输入`umask`命令后，会显示 4 个数字，后面三个依次代表要拿掉的权限。文件的默认权限为最大`-rw-rw-rw`，目录的默认权限为最大`drwxrwxrwx`。★

`chattr`：配置文件隐藏属性。xfs 文件系统仅支持 AadiS 。★

`lsattr`：列出隐藏属性。

`file`：查看文件类型及其他一些信息。

#### 3. 查找命令与文件：

##### 1. 查找命令：

`which`：显示命令的完整路径。（根据 $PATH 环境变量所规范的路径，去查找执行文件的文件名。）

##### 2. 查找文件：

###### 1. 性能稍强：

`whereis`：显示二进制可执行文件、源文件和该命令的 man 手册的路径。（直查找特定目录下面的文件。）

`locate`：根据文件名查找文件。（利用数据库（/var/lib/mlocate）来查找文件。）

`updatedb`：根据 /etc/updatedb.conf 的设置更新数据库。

###### 2. 性能稍弱：

`find`：在目录树中查找文件。（直接在系统硬盘中查找。）

#### 4. 建立链接：

`ln`：默认建立硬链接。

`ln -s`：建立符号链接。

### 3. 关于文件系统：

#### 1. 文件系统相关命令：

`dumpe2fs`：查询 ext 系列文件系统超级区块的信息。（目前 CentOS 7 默认使用 xfs ，所以无法使用该命令查询。）★

`dumpe2fs -h /dev/vda5 | grep 'Blocks per group'`：查询每个区群组的区块个数。Block 号码从 0 开始编，所以第二个超级区块就在显示出来的数字上。★

`blockid`：显示被格式化的设备。

#### 2. 文件系统的简单操作：

`df`：打印文件系统的硬盘空间用量。（ kB 为单位）★

df 主要读取的数据几乎都是针对一整个文件系统，因此读取的范围主要是超级区块中的信息。

`du`：展示文件占用的磁盘空间。（ kB 为单位）★

使用`du -a`命令计算出占用的空间与上面的每个数相加并不相等，因为上面把每个子目录占用的空间也列了出来。★

#### 3. 磁盘分区：

##### 观察分区状态：

`lsblk`：列出系统上的所有磁盘列表。

`blkid`：列出设备的属性。（主要为系统服务而设计，并用来测试 libblkid 的功能。是用来与 *libblkid* library 协同工作的命令行接口。若要查询磁盘或文件系统信息，建议使用`lsblk`；用`findmnt`搜索已经挂载的文件系统。★）

只使用`blkid`命令不带选项和参数，可以用`lsblk -fp`代替。

`parted`：磁盘分区操作命令。

`parted /dev/sda print`：打印 /dev/sda 磁盘的分区格式、容量等数据。

##### 磁盘分区：

`gdisk`与`fdisk`：MBR 分区表使用 fdisk 分区，GPT 分区表使用 gdisk 。按下`?`之后，有命令提示。其中 p 为常用命令，q 与 w 要注意一下。★

`cat /proc/partitions`：查看分区表。★

`partprobe -s`：使内核更新分区表信息。（-s 表示显示设备和分区的信息）

#### 4. 磁盘格式化（创建文件系统）

##### mkfs 创建（格式化）系统：

`mkfs.xfs`等价于`mkfs -t xfs`：创建（格式化）xfs 系统。（里面的属性一般全都使用默认值即可。如果想做一些其他的处理来提高速度，则需要设置一些值。）

`mkfs.ext4`：创建（格式化）ext4 系统。ext4 的默认值已经相当适合我们系统使用。大部分的默认值写入了 /etc/mke2fs.conf 文件中。

想知道系统还支持哪些文件系统的格式化，终端输入`mkfs`后连按两次 tab 键。★

##### mkfs.xfs 设置值：

agcount 可以与 CPU 的内核数来做搭配，以增加速度。（Intel 使用超线程技术，如果是 4 核 CPU ，则系统会模拟出 8 个 CPU，此时 agcount 设置为 8）

`grep 'processer' /proc/cpuinfo`：查看系统的 CPU 数。

#### 5. 文件系统检查（恢复）：

`xfs_repair`：恢复 XFS 文件系统。

`fsck.ext4`：恢复 ext4 文件系统。`fsck`是个综合命令，如果是针对 ext4 的话，建议直接使用`fsck.ext4`来检测。

​		该命令的 -d 选项一般用不到，除非你的超级区块损坏，则可通过该参数利用文件系统内备份的超级区块来尝试恢复。

​		一般来说，超级区块备份在：1K区块在 8193，2K 16384，4K 32768：

|  1K  | 8193  |
| :--: | :---: |
|  2K  | 16384 |
|  4K  | 32768 |

#### 6. 文件系统挂载与卸载

`mount`：挂载文件系统。一些选项：

​		`-t`：常见文件系统类型。`iso9660`是光盘格式；`nfs`、`cifs`、`smbfs`为网络文件系统类型。

​		`-n`：默认情况，系统会将实际挂载的情况即时写入`/etc/mtab`中，以利其他程序运行。但某些情况下（如：单人维护模式）为了避免问题会刻意不写入，此时就要使用该选项。★

​		`-o`：后接一些挂载时额外加上的参数。如：帐号、密码、读写权限等。一些参数：

​				`user，nouser`：一般来说，`mount`仅有 root 可以执行，若执行 user ，可让一般 user 也能对此分区进行`mount`。★

​				`defaults`：默认值为：rw、suid、dev、exec、auto、nouser、and async 。

​				`remount`：重新挂载。这在系统出错或重新更新参数时很有用。★

## 一些快捷键

Tab：双击补齐。

Ctrl + c：命令中断。

Ctrl + d：键盘输入结束（End of File），可以用来取代`exit`的输入。

Shift + Page Up / Down：翻页。

## man page

man 中 NAME 后紧跟的括号后面数字的意义，1、5、8很重要，需要背下来。

*快捷键*：

`blankspace（Page Down）`：向下翻一页。

`Page Up`：向上翻一页。

`Home`：去到第一页。

`End`：去到最后一页。

`/string`：向下查找 string 这个字符串。

`?string`：向上查找 string 这个字符串。

`n, N`：查找后跳往下一个该关键词。

`q`：结束这次的 man page 。

---

## info page

与 man page 类似。

## 一些重要文件的储存位置

/usr/share/doc：软件的安装须知等说明文件的储存目录。

/etc/passwd：帐号的相关信息。

/etc/shadow：帐号的密码。

/etc/group：用户组名。

## 关机

*正确的关机*：关机前多执行几次 `sync` 命令。

`shutdown`：默认一分钟后关机。

`halt`：系统停止，屏幕可能会保留系统已经停止的信息。

`poweroff`：关机。

`reboot`：重启。

`systemctl`：相当复杂的命令，将在系统管理员部分讲到。halt、poweroff、reboot、shutdown 都调用该命令。

## Terminal、Physical console and Virtual console

**Terminal**：在电脑很昂贵的时代，许多设备连接一台主机，那些设备（ *Physical terminal device* ）即 *Terminal* ( *teletype* ，简称 *TTY*)：

![terminal](F:\Note\Linux\Vbird\terminal.png)

**Physical console**：通过物理线缆连接 Linux 系统的物理终端设备（ *Physical terminal device* ）。

**Virtual console**：使用软件模仿物理终端设备来实现控制。

**Physical terminal device**：只由一台显示器和键盘构成的设备。

**Virtual terminal device**：相当于现在的 *Terminal* ，提供一个可以输入的环境来访问 *shell* 。

## 文件权限

`ls -l`之后，会显示文件权限。第一个字母表示文件类型（d 为目录、- 为文件、l 为链接文件（link file））。后面九个依次表示用户、用户组和其他人的权限。

目录的权限与文件稍有不同，目录的`x`权限表示能否进入该目录，而`r`权限表示能否使用`ls`命令查看该目录的文件名。`ls`只能显示该目录下的文件名，其他的都是一堆问号（即使是自己的文件并且拥有所有权限）。★

如果是自己的目录且自己拥有所有的权限，则可以对该目录下的所有文件执行任何操作（即使该文件不是自己的）。★

*特殊权限*：`s`与`t`。

s 在 group 上，(Set GID，缩写为 SGID)，与该组拥有相同权限；s 在 user 上，（Set UID，缩写为 SUID），拥有管理员权限；t 权限（Sticky Bit，缩写为 SBIT）：拥有删除，修改自己的文件的权限。

## 绝对路径与相对路径

绝对路径的正确度比较高，在不同的工作环境中也不易出错。

## 目录相关

`-`：代表前一个（工作）目录。

`~account`：代表 account 这个使用者的家目录（account 是个帐号名称）。

所有目录下都存在 `.`与`..`两个目录，代表此层目录与上层目录。★

/tmp 这个目录是给大家作为缓存用的（我们之前进行测试时，都是将文件移入该目录中去练习的），所以可以时不时清理一下里面无用的文件。★

## 环境变量 PATH

`echo $PATH`或 `echo ${PATH}`：显示目前的 PATH 。

不建议将本目录（`.`）加入 PATH 的查找目录中，为了安全性。★

## Linux 的文件系统

### 1. Linux 的 ext2 文件系统（innode）

![ext2 文件系统磁盘区块](F:\Note\Linux\Vbird\ext2 文件系统磁盘区块.png)

|     Block 大小     | 1kB  |  2kB  | 4kB  |
| :----------------: | :--: | :---: | :--: |
|  最大单一文件限制  | 16GB | 256GB | 2TB  |
| 最大文件系统总容量 | 2TB  |  8TB  | 16TB |

一个区块只能放置一个文件，剩下的空间会浪费掉。★

一个 inode 只有 12 个直接指向。如果不够则需要使用间接指向。

读取文件是从目录中读取 inode 然后在读取对应的区块。

#### 一些命令

`ls -l /lib/modules/$(uname -r)/kernel/fs`：查看你的 Linux 支持的文件系统。

`cat /proc/filesystems`：查看系统目前已加载到内存中支持的文件系统。

### 2. XFS 系统简介

为什么 CentOS 7 默认的文件系统由 ext4 变成了 xfs ？

因为 ext 系列虽然支持度最广，但是格式化超慢，它是预先就把所有的 inode 等规划好，未来直接使用，*所以不适用与当今大磁盘容量的时代*。

xfs 是一个日志式文件系统，它是动态配置 inode 等区块，并且有较快的恢复速度和创建速度，比较适合当今时代。

#### 一些命令

`df -T`：查看该目录的磁盘空间占用情况。-T 表示打印出文件系统的类型。

`xfs_info`：查看挂载点下文件系统的超级区块的记录。

### 3. 一些目录

用`df -a`命名会发现`/proc`里面的东西都是 0 ，这是因为`/proc`里面的东西是系统所需要加载的系统数据，挂载在内存中，所以不占用任何磁盘空间。

`/dev/shm/`目录是利用内存虚拟出来的磁盘空间，通常为总物理内存的一半。

## 硬链接与符号链接：ln

### 1. 硬链接：

文件名只与目录有关，文件内容则与 inode 有关。硬链接即新增一条文件名链接到某 inode 号码的关联记录，此举动消耗的空间很小。删掉源文件，该文件还能打开。所以硬链接安全。

#### 硬链接的限制

- 不能跨文件系统。

- 不能链接目录。（因为会链接该目录下的所有文件，并且新建文件时也会连带建立链接，环境复杂度大，开销大。）

### 2. 符号链接（相当于 Windows 上的快捷方式）：

建立一个独立的文件，该文件的数据读取它链接的那个文件的文件名，在去读取那个文件名的 inode 。删掉源文件，该文件无法打开。

Linux中，修改符号文件时，实际上修改的是原始文件。

---

由于硬链接限制太多，包括无法链接目录等，在用途上就不如符号链接广泛了。所以留意一下符号链接的用法。★

## 磁盘的分区、格式化、检验与挂载

在系统里新增一块磁盘应进行的操作：

1. 对磁盘进行划分，以建立可用的磁盘分区；
2. 对该硬盘进行格式化，以建立系统可用的文件系统；
3. （可对刚刚建立好的文件系统进行检验）；
4. 在 Linux 系统上，需要建立挂载点（亦即是目录），并将它挂载上来；

### UUID（universally unique identifier）：

全局唯一标识符，Linux 会将系统内所有的设备都给予一个独一无二的标识符，可用来作为挂载或是使用这个设备或文件系统。

### 磁盘分区

1. 通过`lsblk`或`blkid`找到磁盘：`lsblk -p`或`blkid`
2. 使用`parted /dev/xxx print`找出分区类型：`parted /dev/sda print`
3. 使用`gdisk`或`fdisk`操作（GPT 用 gdisk，MBR 用 fdisk）：`fdisk /dev/sda`

分区主要以扇区为最小单位。

![fdisk显示分区信息](F:\Note\Linux\Vbird\fdisk显示分区信息.png)

从上表中可以发现，新分区通常选用上一个分区的结束扇区号码数加1作为起始扇区号。

请注意，使用的设备文件名不要加数字，磁盘分区是针对整个磁盘设备，而不是某个分区。★

对于文件系统的 ID，Linux 大概都是 8200，8300，8300 等格式，Windows 几乎都用 0700 。可以在 fdisk 或 gdisk 命令中输入 l 命令显示。

#### 创建分区：（删除分区同理）

1. 使用 fdisk 或 gdisk 中的 n 命令
2. `cat /proc/partitions`查看当前分区表
3. `partprobe -s`或 kpartx 或*重启*来更新分区表

使用 fdisk 或 gdisk 中的 n 命令，根据它的引导，会有一些选项需要选择。几乎都使用默认值，除了 Last Sector 那一行，直接输入 +1G 类似的命令即可，否则会直接占用所有的容量。★

创建完使用 w 命令之后，输入`cat /proc/partions`命令，查看正在使用的分区表，此时并未创建一个新的分区，因为这块磁盘正在使用中，系统无法立即加载新的分区表，内核还未更新。此时需要重启（很不爽），或者使用`partprobe`或`kpartx`命令来处理。★

---

万分注意，不要去处理一个正在使用的分区。如果在使用中将其删除了，那么虽然磁盘会写入正确的分区信息，但内核无法更新分区表的信息，并且会影响文件系统与 Linux 系统的稳定性。★

### gdisk 与 fdisk 的区别

1. gdisk 使用 ? 显示帮助命令，而 fdisk 使用 m
2. 有时 fdisk 会使用柱面（cylinder）作为分区的最小单位，而 gdisk 默认使用扇区（sector）

### 文件系统检验（恢复）

修复文件系统是个庞大的任务，所以修复时该文件系统不能被挂载，否则会报*不能初始化文件系统库* 错误：`fatal error -- couldn't initialize XFS library` 。但是可以先卸载，再进行恢复。

Linux 中根目录无法被卸载，此时需要通过进入单人维护或恢复模式，然后通过`xfs_repair -d`来处理，此时系统强制检验该设备，检验完毕自动重启。（不要随便使用这个选项，很危险。）★

xfs_repari 和 fsck.ext4 都是用来检查和修正文件系统错误的命令，不可随意使用。通常只有身为 root 且文件系统有问题时才使用，否则可能会造成对系统的危害。★

通常使用这个命令的场合都是系统出现极大的问题，导致在启动 Linux 时得进入单人维护模式操作时，才必须使用这些命令。

如果你怀疑刚刚格式化成功的磁盘有问题时，也可使用他们来检查，此时相当于 Windows 的 scandisk。但是，它们在扫描磁盘时，可能会造成部分文件系统的改变，所以执行它们时，被检查的磁盘务必不能挂载到系统上，即它们在卸载状态。

### 文件系统的挂载与卸载

挂载点是目录，这个目录是进入磁盘分区（其实是文件系统）的入口。挂载前最好先确定几件事：

- 单一为文件系统不应该被重复挂载在不同的挂载点（目录）中。
- 单一目录不应该重复挂载多个文件系统。
- 要作为挂载点的目录，理论上应该都是空目录才行。

尤其是后两点，如果要挂载的目录不是空的，那里面的东西会暂时被隐藏，而不是被覆盖，当这个被挂载的分区被卸载后，它们又会重新显示出来。★

挂载文件系统，使用 mount 命令，该命令博大精深，很难，我们学简单一点。

CentOS 7 已经太聪明了，因此不需要加上 -t 这个选项，系统会自动分析最恰当的文件系统来尝试挂载你需要的设备。这也是 blkid 命令能够显示正确的文件系统的缘故。★

#### CentOS 如何找出文件系统类型的？

通过分析超级区块搭配 Linux 自己的驱动程序去测试挂载，若成功，则立刻自动使用该类型的文件系统挂载起来。

#### 哪些类型的文件系统才需要进行上述挂载测试？

- `/etc/filesystems`：系统指定的测试挂载文件系统类型的优先级。
- `/proc/filesystems`：Linux 系统已经加载的文件系统类型。

#### 怎么知道有没有相关文件系统类型的驱动程序？

Linux 支持的文件系统的驱动程序都卸载如下目录中：`/lib/modules/$(uname -r)/kernel/fs/`

---

建议使用 UUID 来识别文件系统，因为独一无二，会比设备名称与标头名称还可靠。★

#### 挂载文件系统、CD或DVD 光盘和 vfat 中文移动磁盘（USB 磁盘）的步骤：

1. 使用`blkid`命令找出该设备的 UUID ，如：`blkid /dev/sda2`
2. 创建需要挂载到的目录，即目的目录，如：`mkdir -p /data/xfs`
3. 将该设备挂载到该目录，如：`mount UUID="e0a6a55-26e7......" /data/xfs`
4. 使用`df`命令查看挂载在该目录下的文件系统的磁盘空间使用量信息，如：`df /data/xfs`

若挂载 ext4 文件系统，可将创建的目录改为`/data/ext4`；

若为 CD、DVD，可将创建目录改为`/data/cdrom`，并将`mount`命令的使用改为`mount /dev/sr0 /data/cdrom`，此时使用`df /data/cdrom`会显示使用掉了 100% 的空间，因为是只读设备，所以不能再写入了。★

​	光驱一旦挂载就无法退出光盘了，除非将其卸载。★

​	此外，如果使用图形界面，系统会自动将这个光盘挂载到`/media`目录，也可以不卸载就直接退出，但命令行就不行。★

若为 USB ，将挂载目录改为`/data/usb`，`mount`改为`mount -o codepage=950, iocharset=utf8 UUID="35BC-......" /data/usb`。

​	如果是中文文件名的数据，可以在挂载时指定挂载文件系统所使用的语系。——在`man mount`找到 vfat 文件格式当中可以使用 `codepage` 来处理，中文语系的代码为 950。若指定编码为 Unicode 还是 Big5，需使用`iocharset`参数。

​	这个 USB 磁盘不能为 NTFS 文件系统，因为 CentOS 7 默认不支持这个系统格式。所以需要安装 NTFS 文件系统的驱动程序，这部分讲到 YUM 服务器再谈。★

#### 重新挂载根目录与挂载不特定目录

整个目录树最重要的就是根目录，所以它根本就不能够被卸载。问题是，若你的挂载参数要改变或是根目录出现 **只读** 状态时，如何重新挂载？

1. 最可能的处理方式，即重新启动。
2. 将`/`重新挂载，并加入参数为`rw`与`auto`：`mount -o remount, rw, auto /`。

重点是那个`-o remount,xx`的选项与参数。要重新挂载时，这是非常重要的机制，尤其是进入单人维护模式时，根目录常会被系统挂载为只读，这时这个命令就太重要了。★

##### 利用`mount`将某个目录挂载到另一个目录：

如：将`/var` 目录暂时挂载到`/data/var`下：

1. `mkdir /data/var`
2. `mount --bind /var /data/var`
3. `ls -lid /var /data/var`：此时会发现两个目录内容完全一样。
4. `mount | grep var`

这并不是挂载文件系统，而是额外挂载某个目录的方法。虽然这也可以使用符号链接来做链接，但在某些情况下不支持。★

这两个目录链接到同一个 inode 。通过`mount --bind` 的功能，可将某个目录挂载到其他目录，而不是整个文件系统，于是从此进入`/data/var`就是进入`var`的意思。★

#### `umount`卸载文件设备





